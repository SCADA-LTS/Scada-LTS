/******************************************
 * FUScaBR - "Funções úteis para o ScadaBR"
 * License: MIT
 ******************************************/
"use strict";fuscabr.ceditor={createdEditors:[],watchdog:null,fileCounter:[0,0],loadDependency:function(e,t,c){var r;"script"==t?(r=document.createElement("script")).src=e:"style"==t&&((r=document.createElement("link")).rel="stylesheet",r.href=e),c&&r.addEventListener("load",c),document.getElementById("fuscabr-modules").appendChild(r)},loadCodeMirror:function(){var e=this.conf;this.loadDependency(e.baseFolder+"codemirror.css","style"),"codemirror.css"!=e.theme&&"default"!=e.theme&&this.loadDependency(e.themesFolder+e.theme,"style"),this.loadDependency(e.baseFolder+"codemirror.min.js","script",fuscabr.ceditor.start)},loadLanguage:function(e,t){var c=this.conf.modesFolder,r=this.conf.addonsFolder,a=[];"html"==e?(a.push(r+"fold/xml-fold.js"),a.push(r+"edit/closebrackets.js"),a.push(r+"edit/closetag.js"),a.push(r+"edit/matchbrackets.js"),a.push(c+"xml/xml.js"),a.push(c+"javascript/javascript.js"),a.push(c+"css/css.js"),a.push(c+"htmlmixed/htmlmixed.js")):"javascript"==e||"json"==e?(a.push(r+"edit/closebrackets.js"),a.push(r+"edit/matchbrackets.js"),a.push(c+"javascript/javascript.js")):"sql"==e&&(a.push(r+"edit/closebrackets.js"),a.push(r+"edit/matchbrackets.js"),a.push(c+"sql/sql.js"));for(var i=[],o=0;o<a.length;o++)document.querySelector("#fuscabr-modules script[src*='"+a[o]+"']")||i.push(a[o]);if(i.length)for(var o of i){var s=fuscabr.ceditor.fileCounter[0]>0?1:0;this.loadDependency(o,"script",function(){fuscabr.ceditor.loadLanguageCb(i.length,s,t)})}else setTimeout(t,200)},loadLanguageCb:function(e,t,c){fuscabr.ceditor.fileCounter[t]++,e==fuscabr.ceditor.fileCounter[t]&&(fuscabr.ceditor.fileCounter[t]=0,c())},updateEditors:function(){for(var e of fuscabr.ceditor.createdEditors)e.setValue(e.getTextArea().value)},updateTextAreas:function(){for(var e of fuscabr.ceditor.createdEditors)e.save()},generalWatchdog:function(e){var t=document.querySelector(e);this.watchdog=t.value,setInterval(function(){fuscabr.ceditor.watchdog!=document.querySelector(e).value&&(fuscabr.ceditor.watchdog=document.querySelector(e).value,fuscabr.ceditor.updateEditors())},this.conf.watchdogInterval)},emportWatchdog:function(e){var t=document.querySelector(e);this.watchdog=setInterval(function(){t.disabled||(fuscabr.ceditor.updateEditors(),clearInterval(fuscabr.ceditor.watchdog))},this.conf.watchdogInterval)},viewEditWatchdog:function(e){var t=document.querySelector(e);this.watchdog=setInterval(function(){"none"!=t.style.display&&(fuscabr.ceditor.updateEditors(),clearInterval(fuscabr.ceditor.watchdog))},this.conf.watchdogInterval)},createEditor:function(e,t,c){var r=document.querySelector(e),a={lineNumbers:!0,indentUnit:4};"default"!=this.conf.theme&&"codemirror.css"!=this.conf.theme&&(a.theme=this.conf.theme.replace(".css","")),a.autoCloseBrackets=!0,a.matchBrackets=!0,"html"==t||"htmlmixed"==t?(a.mode="htmlmixed",a.autoCloseTags=!0):"javascript"==t||"json"==t?(a.mode={name:"javascript"},a.mode.json="json"==t):"sql"==t&&(a.mode="sql");var i=CodeMirror.fromTextArea(r,a),o=this.conf.editorSize;o[c]?i.setSize(o[c].width,o[c].height):i.setSize(o.default.width,o.default.height),i.refresh(),this.createdEditors.push(i)},createListener:function(e,t,c,r){var a=document.querySelector(e);r&&(a=a.parentElement),a&&a.addEventListener(t,c,!0)},createCustomCSS:function(){var e=document.createElement("style");e.innerHTML=".CodeMirror { border: 1px solid "+this.conf.editorBorderColor+";",e.innerHTML+="font-size: "+this.conf.editorFontSize+"}",document.getElementById("fuscabr-modules").appendChild(e)},start:function(){var e=window.location.href,t=fuscabr.ceditor;t.createCustomCSS(),e.includes("sql.shtm")?t.loadLanguage("sql",function(){t.createEditor("#sqlString","sql","sql.shtm")}):e.includes("emport.shtm")?(t.loadLanguage("json",function(){t.createEditor("#emportData","json","emport.shtm")}),t.createListener("#exportJsonBtn","click",function(){t.emportWatchdog("#exportJsonBtn")}),t.createListener("#importJsonBtn","click",t.updateTextAreas)):e.includes("point_links.shtm")?(t.loadLanguage("javascript",function(){t.createEditor("#script","javascript","point_links.shtm")}),t.generalWatchdog("#xid"),t.createListener("img[onclick*='savePointLink()']","click",t.updateTextAreas,!0),t.createListener("img[onclick*='validateScript()']","click",t.updateTextAreas,!0)):e.includes("compound_events.shtm")?(t.loadLanguage("javascript",function(){t.createEditor("#condition","javascript","compound_events.shtm")}),t.generalWatchdog("#xid"),t.createListener("img[onclick*='saveCompoundEvent()']","click",t.updateTextAreas,!0),t.createListener("img[onclick*='validate()']","click",t.updateTextAreas,!0),insertText=function(e){t.createdEditors[0].replaceSelection(e)}):e.includes("scripting.shtm")?(t.loadLanguage("javascript",function(){t.createEditor("#script","javascript","scripting.shtm")}),t.generalWatchdog("#xid"),t.createListener("#executeScriptImg","click",t.updateTextAreas,!0),t.createListener("img[onclick*='saveScript()']","click",t.updateTextAreas,!0)):e.includes("view_edit.shtm")?(t.loadLanguage("javascript",function(){t.createEditor("#graphicRendererScriptScript","javascript","view_edit.shtm")}),t.loadLanguage("html",function(){t.createEditor("#staticPointContent","html","view_edit.shtm")}),t.createListener("#graphicRendererScriptScript","change",t.updateEditors),t.createListener("#staticPointContent","change",t.updateEditors),t.createListener("#graphicRendererEditorPopup .fuscabr-csnippet-apply","click",t.updateEditors),t.createListener("#htmlEditor .fuscabr-csnippet-apply","click",t.updateEditors),t.createListener("img[onclick*='staticEditor.save()']","click",t.updateTextAreas,!0),t.createListener("img[onclick*='graphicRendererEditor.save()']","click",t.updateTextAreas,!0),openStaticEditor=function(e){closeEditors(),fuscabr.ceditor.viewEditWatchdog("#staticEditorPopup"),staticEditor.open(e)},openGraphicRendererEditor=function(e){closeEditors(),fuscabr.ceditor.viewEditWatchdog("#graphicRendererEditorPopup"),graphicRendererEditor.open(e)}):e.includes("data_source_edit.shtm")&&(document.getElementById("webcamLiveFeedCode")?(t.loadLanguage("html",function(){t.createEditor("#webcamLiveFeedCode","html","httpimage_ds")}),t.generalWatchdog("#xid"),t.createListener("img[onclick*='savePoint()']","click",t.updateTextAreas,!0)):document.getElementById("script")?(t.loadLanguage("javascript",function(){t.createEditor("#script","javascript","meta_ds")}),t.generalWatchdog("#xid"),t.createListener("img[onclick*='validateScript()']","click",t.updateTextAreas,!0),t.createListener("img[onclick*='savePoint()']","click",t.updateTextAreas,!0)):document.getElementById("selectStatement")&&(t.loadLanguage("sql",function(){t.createEditor("#selectStatement","sql","sql_ds_1")}),t.loadLanguage("sql",function(){t.createEditor("textarea[name='updateStatement']","sql","sql_ds_2")}),t.generalWatchdog("#xid"),t.createListener("#sqlTestBtn","click",t.updateTextAreas,!0),t.createListener("img[onclick*='saveDataSource()']","click",t.updateTextAreas,!0),t.createListener("img[onclick*='savePoint()']","click",t.updateTextAreas,!0)))},getSettings:function(){ajaxGetJson("resources/fuscabr/conf/modules/ceditor.json",function(e){fuscabr.ceditor.conf=e,fuscabr.ceditor.init()})},init:function(){fuscabr.ceditor.conf?fuscabr.ceditor.loadCodeMirror():fuscabr.ceditor.getSettings()}},fuscabr.ceditor.init();
