/******************************************
 * FUScaBR - "Funções úteis para o ScadaBR"
 * Version 2.0 - License: MIT
 ******************************************/
"use strict";fuscabr.chart={createdCharts:[],loop:function(){var t=document.querySelectorAll("div:not(.fuscabr-chart-container) > div > input.fuscabr-chart-data");e=t.length;for(var a=0;a<e;a++)fuscabr.chart.createNewCharts(t[a]);var e=fuscabr.chart.createdCharts.length;for(a=0;a<e;a++){-1==fuscabr.chart.updateCharts(fuscabr.chart.createdCharts[a])&&fuscabr.chart.createdCharts.splice(a,1)}},createNewCharts:function(t){if("undefined"!=typeof Chart){var a=this.formatData(t.value),e=t.parentElement.parentElement,r=a[0],s=document.createElement("canvas"),n=document.createElement("div"),i=this.conf.timeOptions;s.classList.add("fuscabr-chart-canvas"),n.style="position: relative; height: "+r.height+"px; width: "+r.width+"px;",n.appendChild(s),e.appendChild(n),e.classList.add("fuscabr-chart-container");var o=s.getContext("2d"),c=new Chart(o,{type:r.type,data:r.data});c.options.elements.line.tension=0,c.options.maintainAspectRatio=!1,1==r.beginAtZero&&(c.options.scales.yAxes[0].ticks.beginAtZero=!0),0==r.animations&&(c.options.animation.duration=0),1==r.timeBased?(c.options.scales.xAxes[0].type="time",c.options.scales.xAxes[0].time=i):(c.options.scales.xAxes[0].ticks.display=!1,c.options.scales.xAxes[0].gridLines.drawTicks=!1),1==r.showTitle&&(c.options.title.display=!0,c.options.title.text=r.title),this.conf.enableDatapointWarnings&&this.invalidDatapointWarning(e,a[1]),c.update(),fuscabr.chart.createdCharts.push(c)}else this.loadChartJs()},updateCharts:function(t){var a=t.canvas.parentElement.parentElement,e=new Array,r={};try{r=(e=this.formatData(a.querySelector(".fuscabr-chart-data").value))[0]}catch{return fuscabr.chart.destroyChart(t),-1}if(t.config.type!=r.type)return fuscabr.chart.destroyChart(t),-1;if(t.options.scales.xAxes[0]&&"time"==t.options.scales.xAxes[0].type!=r.timeBased)return fuscabr.chart.destroyChart(t),-1;if(t.data.datasets.length!=r.data.datasets.length)return fuscabr.chart.destroyChart(t),-1;t.canvas.parentElement.style.height=r.height+"px",t.canvas.parentElement.style.width=r.width+"px";var s=!1,n=t.options.scales.yAxes[0].ticks.beginAtZero;n!=r.beginAtZero&&(t.options.scales.yAxes[0].ticks.beginAtZero=r.beginAtZero,s=!0),(n=t.options.animation.duration>0)!=r.animations&&(t.options.animation.duration=1==r.animations?1e3:0,s=!0),(n=t.options.title.display)!=r.showTitle&&(t.options.title.display=r.showTitle,t.options.title.text=r.title,s=!0);for(var i=r.data.datasets.length,o=0;o<i;o++){var c=t.data.datasets[o].data,d=r.data.datasets[o].data;JSON.stringify(c)!=JSON.stringify(d)&&(t.data.datasets[o].data=d,s=!0),(c=t.data.datasets[o].label)!=(d=r.data.datasets[o].label)&&(t.data.datasets[o].label=d,s=!0),(c=t.data.datasets[o].backgroundColor)!=(d=r.data.datasets[o].backgroundColor)&&(t.data.datasets[o].backgroundColor=d,t.data.datasets[o].borderColor=d,s=!0)}this.conf.enableDatapointWarnings&&this.invalidDatapointWarning(a,e[1]),1==s&&t.update()},destroyChart:function(t){var a=t.canvas.parentElement;a.parentElement.classList.remove("fuscabr-chart-container"),t.destroy(),a.remove()},invalidDatapointWarning:function(t,a){if(t.querySelector(".fuscabr-chart-warning"))t.querySelector(".fuscabr-chart-warning").innerHTML=a;else{var e=document.createElement("span");e.className="fuscabr-chart-warning",e.innerHTML=a,t.appendChild(e)}},formatData:function(t){var a=JSON.parse(t),e=[{},""];for(var r in e[0]=a,e[0].data.datasets){var s=e[0].data.datasets[r];if("undefined"==s.backgroundColor&&(e[0].data.datasets[r].backgroundColor=this.conf.fallbackBackgroundColor),"undefined"==s.borderColor&&(e[0].data.datasets[r].borderColor=this.conf.fallbackBorderColor),0!=s.data.length)if(e[0].timeBased){var n=String(s.data[0].y);if(0==isNaN(parseFloat(n)))continue;if("false"==n||"true"==n){for(var r of e[0].data.datasets[r].data)"true"==String(r.y)?r.y=1:r.y=0;continue}e[0].data.datasets.splice(r,1),this.conf.enableDatapointWarnings&&(e[1]+="&quot;"+s.label+"&quot; is not a numeric or binary datapoint <br>")}else{n=String(s.data[0]);if(0==isNaN(parseFloat(n)))continue;if("false"==n||"true"==n){for(var r of e[0].data.datasets[r].data)r="true"==String(r)?1:0;continue}e[0].data.datasets.splice(r,1),this.conf.enableDatapointWarnings&&(e[1]+="&quot;"+s.label+"&quot; is not a numeric or binary datapoint <br>")}}return e},loadChartJs:function(){if(!document.getElementById("fuscabr-chartjs")){var t=document.createElement("script");t.src=this.conf.chartJsFile,t.id="fuscabr-chartjs",t.onload=fuscabr.chart.loop,document.getElementById("fuscabr-modules").appendChild(t)}},getSettings:function(){ajaxGetJson("resources/fuscabr/conf/modules/chart.json",function(t){fuscabr.chart.conf=t,fuscabr.chart.init()})},init:function(){fuscabr.chart.conf?(fuscabr.chart.loop(),setInterval(function(){fuscabr.chart.loop.call(fuscabr.chart)},fuscabr.chart.conf.refreshTime)):fuscabr.chart.getSettings()}},fuscabr.chart.init();
